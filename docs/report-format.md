# Report Format Documentation

This document describes the format of policy check reports generated by repo-policy.

## Overview

After running `repo-policy check`, two report files are generated in the output directory:

- `policy_report.json` - Machine-readable JSON report
- `policy_report.md` - Human-readable Markdown report

Both reports contain the same information but in different formats optimized for their respective use cases.

## JSON Report Format

### Schema

The JSON report follows this schema:

```json
{
  "version": "1.0",
  "generated_at": "2025-12-13T23:05:52.900319Z",
  "metadata": {
    "repo_path": "/path/to/repository",
    "config_file": "repo-policy.yml",
    "commit_hash": "abc123def456...",
    "config_hash": "7d2e6a18538da4d62b05942115df5b1b0ccfae2a193b5016893a479230ca54d7",
    "analyzer_version": "1.0.0",
    "license_header_tool_version": "2.0.1"
  },
  "summary": {
    "total_rules": 9,
    "passed_rules": 7,
    "failed_rules": 1,
    "skipped_rules": 1,
    "error_count": 0,
    "warning_count": 1
  },
  "rules": [
    {
      "rule_id": "ci-required",
      "severity": "warning",
      "status": "fail",
      "message": "CI workflows found but no test commands detected",
      "evidence": {
        "has_ci": true,
        "has_test_commands": false,
        "workflow_files": [".github/workflows/test.yml"]
      },
      "remediation": "Ensure your CI workflows run tests...",
      "tags": ["hygiene", "ci", "testing"]
    }
  ],
  "artifacts": {
    "analyzer": {
      "status": "success",
      "output_files": ["repo-metadata.json"],
      "version": "1.0.0"
    },
    "license_headers": {
      "status": "skipped"
    }
  }
}
```

### Field Descriptions

#### Root Level

- `version` (string): Report schema version (currently "1.0")
- `generated_at` (string): ISO 8601 timestamp in UTC when the report was generated
- `metadata` (object): Repository and tool metadata
- `summary` (object): Summary statistics of rule evaluation
- `rules` (array): Detailed results for each rule evaluated
- `artifacts` (object): Information about integration artifacts

#### Metadata Object

- `repo_path` (string): Absolute path to the repository
- `config_file` (string): Name of the configuration file used
- `commit_hash` (string, optional): Git commit hash of the repository
- `config_hash` (string, optional): SHA-256 hash of the configuration file
- `analyzer_version` (string, optional): Version of the repo-analyzer tool
- `license_header_tool_version` (string, optional): Version of the license-header tool

#### Summary Object

- `total_rules` (integer): Total number of rules evaluated
- `passed_rules` (integer): Number of rules that passed
- `failed_rules` (integer): Number of rules that failed
- `skipped_rules` (integer): Number of rules that were skipped
- `error_count` (integer): Number of error-level failures
- `warning_count` (integer): Number of warning-level failures

#### Rule Object

- `rule_id` (string): Unique identifier for the rule
- `severity` (string): Rule severity level ("error", "warning", or "info")
- `status` (string): Evaluation status ("pass", "fail", "skip", or "warn")
- `message` (string): Human-readable result message
- `evidence` (object): Supporting evidence for the result (structure varies by rule)
- `remediation` (string): Suggested remediation steps (empty for passing rules)
- `tags` (array of strings): Tags categorizing the rule

#### Artifacts Object

Contains information about integration tool outputs:

- `analyzer` (object, optional): Repository analyzer results
  - `status` (string): "success", "failed", or "not_run"
  - `output_files` (array of strings): Paths to output files
  - `version` (string, optional): Tool version
  - `error_message` (string, optional): Error message if failed

- `license_headers` (object, optional): License header check results
  - `status` (string): "success", "failed", "skipped", or "not_run"
  - `compliant_files` (array of strings): Files with valid headers
  - `non_compliant_files` (array of strings): Files missing or with invalid headers
  - `version` (string, optional): Tool version
  - `error_message` (string, optional): Error message if failed

### Determinism

The JSON report is generated with deterministic ordering:

1. All object keys are sorted alphabetically (via `sort_keys=True`)
2. Rules are sorted by `rule_id`
3. Rule tags are sorted alphabetically
4. File lists in artifacts are sorted alphabetically

This ensures that repeated runs on unchanged repositories produce identical JSON files (excluding the timestamp).

## Markdown Report Format

### Structure

The Markdown report contains the following sections:

1. **Header** - Title and generation timestamp
2. **Overview** - Summary statistics and metadata
3. **Failures** - Detailed information about failed rules (errors and warnings)
4. **Passed Rules** - List of rules that passed
5. **Skipped Rules** - List of rules that were skipped
6. **Artifacts** - Information about integration tool outputs
7. **Command Guidance** - How to re-run the check

### Example

```markdown
# Policy Check Report

**Generated:** 2025-12-13 23:05:52 UTC

---

## Overview

### Summary

- **Total Rules:** 9
- **Passed:** 7
- **Failed:** 1
  - Errors: 0
  - Warnings: 1
- **Skipped:** 1

**Status:** ✅ PASS

### Metadata

- **Repository:** `/home/runner/work/repo-policy/repo-policy`
- **Config File:** `repo-policy.yml`
- **Commit Hash:** `39929f676157acffa662390eb953a947e099882e`
- **Config Hash:** `7d2e6a18538d...`

## Failures

### ⚠️ ci-required

**Severity:** WARNING

**Message:** CI workflows found but no test commands detected (heuristic check)

**Evidence:**

- **has_ci:** `True`
- **has_test_commands:** `False`
- **workflow_files:** (1 items)
  - `.github/workflows/af_maintenance.yml`

**Remediation:**

Ensure your CI workflows run tests...

---

## Passed Rules

The following rules passed successfully:

- ✅ `file-size-limit`: No large files found
- ✅ `forbidden-files`: No forbidden files found
- ✅ `gitignore-required`: .gitignore file found

## Skipped Rules

The following rules were skipped:

- ⏭️ `license-header-required`: License header enforcement is disabled

## Artifacts

### Repository Analyzer

**Status:** ❌ Failed

**Error:** repo-analyzer tool not found

### License Headers

**Status:** ⏭️ Skipped (not required)

## Command Guidance

To re-run the policy check:

```bash
repo-policy check
```

For more options:

```bash
repo-policy --help
```
```

### Formatting Rules

- Status indicators use emoji for visual clarity:
  - ✅ - Success/Pass
  - ❌ - Error/Fail
  - ⚠️ - Warning
  - ⏭️ - Skipped

- Evidence lists are summarized when they exceed 20 items:
  ```
  - **files:** (50 items, showing first 20)
    - `file1.py`
    ...
    - _(... and 30 more)_
  ```

- Failures are sorted by severity (errors first) then by rule ID
- Passed and skipped rules are sorted by rule ID
- Evidence keys are sorted alphabetically

## Using Reports in CI/CD

### Exit Codes

The `repo-policy check` command returns:

- `0` - Success (no error-level failures)
- `1` - Failed (one or more error-level failures)
- `130` - Interrupted by user (Ctrl+C)

The exit code is based only on error-level failures. Warning-level failures do not cause a non-zero exit code.

### JSON Report for Automation

The JSON report can be parsed by CI/CD systems for automated decision-making:

```bash
#!/bin/bash
# Example: Parse JSON report in CI

repo-policy check
EXIT_CODE=$?

# Parse summary from JSON report
ERRORS=$(jq '.summary.error_count' .repo-policy-output/policy_report.json)
WARNINGS=$(jq '.summary.warning_count' .repo-policy-output/policy_report.json)

echo "Errors: $ERRORS, Warnings: $WARNINGS"

# Fail the build on errors
if [ "$ERRORS" -gt 0 ]; then
    echo "Policy check failed with $ERRORS error(s)"
    exit 1
fi

# Optional: Warn but don't fail on warnings
if [ "$WARNINGS" -gt 0 ]; then
    echo "::warning::Policy check found $WARNINGS warning(s)"
fi
```

### Markdown Report for Pull Requests

The Markdown report can be posted as a PR comment:

```yaml
# Example: GitHub Actions workflow
- name: Run policy check
  run: repo-policy check

- name: Comment PR with report
  uses: actions/github-script@v6
  if: github.event_name == 'pull_request'
  with:
    script: |
      const fs = require('fs');
      const report = fs.readFileSync('.repo-policy-output/policy_report.md', 'utf8');
      github.rest.issues.createComment({
        issue_number: context.issue.number,
        owner: context.repo.owner,
        repo: context.repo.repo,
        body: report
      });
```

## Report Location

By default, reports are written to `.repo-policy-output/` in the current directory:

- `.repo-policy-output/policy_report.json`
- `.repo-policy-output/policy_report.md`

You can override this location with the `--outdir` flag:

```bash
repo-policy --outdir /tmp/reports check
```

The report paths are logged at the end of the check command:

```
Reports generated:
  JSON: /tmp/reports/policy_report.json
  Markdown: /tmp/reports/policy_report.md
```

## Versioning

The report format version is included in the JSON report (`"version": "1.0"`). Future versions may add new fields but will maintain backward compatibility within the same major version.

Breaking changes to the report schema will increment the major version number (e.g., "2.0").
